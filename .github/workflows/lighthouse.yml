name: Lighthouse CI

on:
  deployment_status:

permissions:
  contents: write # Permission for GitHub Pages deployment

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success' &&
      (startsWith(github.event.deployment_status.environment, 'Production') ||
      startsWith(github.event.deployment_status.environment, 'production'))

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for deployment
        run: sleep 10

      - name: Run Lighthouse CI
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            ${{ github.event.deployment_status.target_url }}
            ${{ github.event.deployment_status.target_url }}/posts
            ${{ github.event.deployment_status.target_url }}/about
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3

      - name: Parse Lighthouse Results
        id: parse
        run: |
          MANIFEST=".lighthouseci/manifest.json"

          if [ -f "$MANIFEST" ]; then
            PERF=$(jq -r '.[0].summary.performance' $MANIFEST 2>/dev/null || echo "0")
            ACCESS=$(jq -r '.[0].summary.accessibility' $MANIFEST 2>/dev/null || echo "0")
            BEST=$(jq -r '.[0].summary["best-practices"]' $MANIFEST 2>/dev/null || echo "0")
            SEO=$(jq -r '.[0].summary.seo' $MANIFEST 2>/dev/null || echo "0")
            
            echo "perf=$PERF" >> $GITHUB_OUTPUT
            echo "accessibility=$ACCESS" >> $GITHUB_OUTPUT
            echo "best_practices=$BEST" >> $GITHUB_OUTPUT
            echo "seo=$SEO" >> $GITHUB_OUTPUT
          else
            echo "perf=0" >> $GITHUB_OUTPUT
            echo "accessibility=0" >> $GITHUB_OUTPUT
            echo "best_practices=0" >> $GITHUB_OUTPUT
            echo "seo=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate GitHub Pages Report
        run: |
          # Create date-based directory
          DATE=$(date +%Y-%m-%d)
          TIME=$(date +%H-%M-%S)
          REPORT_DIR="lighthouse-reports/$DATE/$TIME"
          mkdir -p $REPORT_DIR

          # Copy Lighthouse results
          cp -r .lighthouseci/* $REPORT_DIR/

          # Create index page with latest report list
          cat > lighthouse-reports/index.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>Lighthouse Reports</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
              h1 { color: #333; }
              .report { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
              .report:hover { background: #f5f5f5; }
              .score { display: inline-block; padding: 5px 10px; border-radius: 3px; margin: 5px; }
              .good { background: #0cce6b; color: white; }
              .average { background: #ffa400; color: white; }
              .poor { background: #ff4e42; color: white; }
            </style>
          </head>
          <body>
            <h1>üî¶ Lighthouse CI Reports</h1>
            <div class="report">
              <h3>Latest Report - $DATE $TIME</h3>
              <div>
                <span class="score good">Performance: $(printf '%.0f' $(echo "${{ steps.parse.outputs.perf }} * 100" | bc))</span>
                <span class="score good">Accessibility: $(printf '%.0f' $(echo "${{ steps.parse.outputs.accessibility }} * 100" | bc))</span>
                <span class="score good">Best Practices: $(printf '%.0f' $(echo "${{ steps.parse.outputs.best_practices }} * 100" | bc))</span>
                <span class="score good">SEO: $(printf '%.0f' $(echo "${{ steps.parse.outputs.seo }} * 100" | bc))</span>
              </div>
              <p><a href="$REPORT_DIR/manifest.json">View Full Report</a></p>
            </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./lighthouse-reports
          keep_files: true
          destination_dir: lighthouse

      - name: Send to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PERF: ${{ steps.parse.outputs.perf }}
          ACCESS: ${{ steps.parse.outputs.accessibility }}
          BEST: ${{ steps.parse.outputs.best_practices }}
          SEO: ${{ steps.parse.outputs.seo }}
          DEPLOY_URL: ${{ github.event.deployment_status.target_url }}
          REPORT_URL: ${{ steps.lighthouse.outputs.links }}
          COMMIT_SHA: ${{ github.sha }}
          PAGES_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/lighthouse
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "DISCORD_WEBHOOK is not set. Skipping Discord notification."
            exit 0
          fi

          PERF_SCORE=$(printf '%.0f' $(echo "$PERF * 100" | bc))
          ACCESS_SCORE=$(printf '%.0f' $(echo "$ACCESS * 100" | bc))
          BEST_SCORE=$(printf '%.0f' $(echo "$BEST * 100" | bc))
          SEO_SCORE=$(printf '%.0f' $(echo "$SEO * 100" | bc))

          if (( $(echo "$PERF >= 0.9" | bc -l) )); then
            COLOR=3066993
          elif (( $(echo "$PERF >= 0.5" | bc -l) )); then
            COLOR=15844367
          else
            COLOR=15158332
          fi

          get_emoji() {
            local score=$1
            if (( $(echo "$score >= 0.9" | bc -l) )); then
              echo "üü¢"
            elif (( $(echo "$score >= 0.5" | bc -l) )); then
              echo "üü°"
            else
              echo "üî¥"
            fi
          }

          PERF_EMOJI=$(get_emoji $PERF)
          ACCESS_EMOJI=$(get_emoji $ACCESS)
          BEST_EMOJI=$(get_emoji $BEST)
          SEO_EMOJI=$(get_emoji $SEO)

          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"üî¶ Lighthouse CI Report\",
                \"description\": \"Performance analysis completed for production deployment\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"$PERF_EMOJI Performance\", \"value\": \"**$PERF_SCORE**/100\", \"inline\": true},
                  {\"name\": \"$ACCESS_EMOJI Accessibility\", \"value\": \"**$ACCESS_SCORE**/100\", \"inline\": true},
                  {\"name\": \"$BEST_EMOJI Best Practices\", \"value\": \"**$BEST_SCORE**/100\", \"inline\": true},
                  {\"name\": \"$SEO_EMOJI SEO\", \"value\": \"**$SEO_SCORE**/100\", \"inline\": true},
                  {\"name\": \"üîó Links\", \"value\": \"[üåê Deployment]($DEPLOY_URL) ‚Ä¢ [üìö Archive]($PAGES_URL)\", \"inline\": false}
                ],
                \"footer\": {\"text\": \"Commit: ${COMMIT_SHA:0:7}\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
              }]
            }" \
            $DISCORD_WEBHOOK
